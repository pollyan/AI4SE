---
description: 强制执行测试驱动开发 (TDD) 工作流，适用于所有编码任务
globs: **/*.{ts,tsx,py,js,jsx,java,go,rs}
alwaysApply: true
---

# TDD (测试驱动开发) 协议

## 核心原则
在进行所有功能开发和 Bug 修复时，必须严格遵循 **红 (Red) - 绿 (Green) - 重构 (Refactor)** 循环。
**绝对禁止** 在没有失败测试的情况下编写实现代码。

## 工作流步骤

### 1. 红灯 (编写失败测试)
- **行动**: 创建或修改一个测试用例，使其反映新的需求或复现 Bug。
- **约束**: 此时 **禁止** 修改实现文件。
- **验证**: 运行测试。
- **输出**: 你必须向用户展示测试 **失败** (或编译失败) 的结果。
- **停止**: 在此暂停。确认失败符合预期。

### 2. 绿灯 (让测试通过)
- **行动**: 编写 **最小量** 的实现代码以通过测试。
- **约束**: 不要过度设计。只关注让失败的测试通过。
- **验证**: 再次运行测试。
- **输出**: 确认测试 **通过**。

### 3. 重构 (清理代码)
- **行动**: 优化代码结构、可读性和性能。
- **约束**: 确保在此阶段测试始终保持通过状态。

## 异常处理
- 如果任务纯粹是“重构”(无行为变更)，必须 **先** 运行现有测试确保是绿灯，然后再重构。
- 如果任务是“配置/环境”(如 docker, 样式调整)，必须先定义手动验证步骤(或脚本验证)。

## 自我纠正触发器
如果你发现自己在编写功能代码 (例如在 `src/` 或 `backend/` 中) 却在对话历史中找不到最近的失败测试输出：
> 🛑 **立即停止**
> 向用户道歉：“我违反了 TDD 规则。我必须回滚并先编写测试。”
> 删除代码并开始“红灯”阶段。
