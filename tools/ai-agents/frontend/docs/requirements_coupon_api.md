# 营销活动-优惠券领取接口需求文档 (v1.0)

## 1. 业务背景
为了支持大促活动（如双11），需要开发一个高性能、高可靠的优惠券领取接口。该接口将承载用户在前端页面的“立即领取”操作，并作为活动的核心入口。

## 2. 接口定义

- **接口名称**: 领取优惠券
- **URL**: `POST /api/v2/promotion/coupon/claim`
- **Content-Type**: `application/json`
- **认证方式**: Bearer Token (需登录)

## 3. 请求参数 (Request Body)

| 字段名 | 类型 | 必填 | 描述 | 约束 |
| :--- | :--- | :--- | :--- | :--- |
| `userId` | String | 是 | 用户唯一标识 | 长度 32位 UUID，不能为空 |
| `activityId` | Long | 是 | 营销活动ID | 正整数，对应 `promotion_activity` 表主键 |
| `couponTemplateId` | Long | 是 | 优惠券模板ID | 正整数，对应 `coupon_template` 表主键 |
| `source` | String | 否 | 来源渠道 | 枚举值: `APP`, `WEB`, `H5`，默认为 `WEB` |
| `riskToken` | String | 否 | 风控设备指纹 | 用于反作弊校验 (可选) |

**请求示例:**
```json
{
  "userId": "u1234567890abcdef1234567890abcde",
  "activityId": 1001,
  "couponTemplateId": 5002,
  "source": "APP"
}
```

## 4. 响应参数 (Response Body)

**成功 (Success 200 OK):**
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "couponCode": "CP20231001000599",  // 发放的具体券码
    "expireTime": "2023-11-01 23:59:59", // 过期时间
    "value": 50.00,                      // 优惠面额
    "status": "UNUSED"                   // 初始状态
  }
}
```

**失败 (Failure 400 Bad Request):**
```json
{
  "code": 2001,
  "message": "活动尚未开始，请耐心等待",
  "data": null
}
```

## 5. 核心业务规则 (Business Logic)

### 5.1 活动状态校验
1.  **活动是否存在**: 根据 `activityId` 查询活动，若不存在返回错误 `40401`。
2.  **活动时间**: 当前服务器时间必须在 `startTime` 和 `endTime` 之间。
    - 若 `now < startTime`，返回 `2001` (未开始)。
    - 若 `now > endTime`，返回 `2002` (已结束)。
3.  **活动状态**: 活动必须处于 `ONLINE` (进行中) 状态，若为 `DRAFT` 或 `OFFLINE`，返回 `2002`。

### 5.2 库存校验 (并发控制)
1.  **总库存**: 检查 `couponTemplateId` 对应的剩余库存 (`stock`)。
2.  **原子扣减**: 必须保证并发扣减的原子性 (如 Redis Lua 或 DB 乐观锁)。
3.  **库存不足**: 若库存 <= 0，返回 `2003` (手慢了，已抢光)。

### 5.3 用户限领规则
1.  **单人限领**: 每个 `userId` 在同一个 `activityId` 下，针对同一张券 (`couponTemplateId`) 最多领取 N 张。
    - 默认限领 1 张。
    - 若用户已领数量 >= N，返回 `2004` (您已领取过，请勿重复领取)。
2.  **每日限领**: (可选规则) 若配置了每日限领，需校验当天领取记录。

### 5.4 用户属性限制
1.  **新老用户**: 若优惠券配置了 `userType=NEW` (仅限新用户)，则需校验用户注册时间是否在 24小时内，且无历史订单。
    - 若老用户尝试领取，返回 `2005` (仅限新用户领取)。

### 5.5 风控拦截
1.  若请求携带 `riskToken` 且被判定为黑产/刷单用户，直接返回 `40301` (请求异常)。

## 6. 错误码定义 (Error Codes)

| 错误码 | 描述 | HTTP状态码 |
| :--- | :--- | :--- |
| `0` | 成功 | 200 |
| `2001` | 活动未开始 | 400 |
| `2002` | 活动已结束或下线 | 400 |
| `2003` | 库存不足 (抢光了) | 400 |
| `2004` | 超过领取限制 (重复领取) | 400 |
| `2005` | 不满足用户条件 (如仅限新客) | 400 |
| `40401` | 活动或优惠券不存在 | 404 |
| `40301` | 风控拦截 | 403 |
| `50001` | 系统繁忙 (并发过高) | 500 |
