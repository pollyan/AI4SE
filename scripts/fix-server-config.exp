#!/usr/bin/expect -f

# ä¿®å¤æœåŠ¡å™¨é…ç½®
set timeout 60
set server_ip "120.53.220.231"
set server_user "ubuntu"
set server_password "Shunlian04"

puts "\n=========================================="
puts "ğŸ”§ ä¿®å¤æœåŠ¡å™¨é…ç½®"
puts "=========================================="

spawn ssh $server_user@$server_ip

expect "password:" {
    send "$server_password\r"
}

expect "ubuntu@*" {
    puts "\nâœ… å·²è¿æ¥\n"
}

# 1. å®‰è£… docker-compose
puts "1ï¸âƒ£  å®‰è£… docker-compose..."
send "sudo apt install -y docker-compose\r"
expect {
    "password" {
        send "$server_password\r"
        expect "ubuntu@*"
    }
    "ubuntu@*" {}
}

# ç­‰å¾…å®‰è£…å®Œæˆ
set timeout 120
expect "ubuntu@*"

# 2. æ‰‹åŠ¨é…ç½® .env (ä¿®å¤ SECRET_KEY)
puts "\n2ï¸âƒ£  ä¿®å¤ .env æ–‡ä»¶..."
send "cd /opt/intent-test-framework\r"
expect "ubuntu@*"

send "RANDOM_KEY=\\\$(openssl rand -hex 32)\r"
expect "ubuntu@*"

send "cat > .env << 'ENVEOF'\r"
expect ">"
send "DATABASE_URL=postgresql://postgres.jzmqsuxphksbulrbhebp:Shunlian04@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?sslmode=require&connect_timeout=15&application_name=prod\r"
expect ">"
send "SECRET_KEY=PLACEHOLDER\r"
expect ">"
send "FLASK_ENV=production\r"
expect ">"
send "WEB_PORT=5001\r"
expect ">"
send "ENVEOF\r"
expect "ubuntu@*"

send "sed -i \"s/PLACEHOLDER/\\\$RANDOM_KEY/\" .env\r"
expect "ubuntu@*"

puts "\nâœ… .env æ–‡ä»¶å·²ä¿®å¤"

# 3. æ˜¾ç¤ºæœ€ç»ˆé…ç½®
puts "\n3ï¸âƒ£  éªŒè¯é…ç½®..."
send "cat .env\r"
expect "ubuntu@*"

puts "\n=========================================="
puts "âœ… ä¿®å¤å®Œæˆï¼"
puts "=========================================="
puts "\nğŸ“‹ ä¸‹ä¸€æ­¥ï¼š"
puts "1. éœ€è¦æ‰‹åŠ¨æ¨é€ä»£ç åˆ°æœåŠ¡å™¨ï¼ˆGit å…‹éš†å¤±è´¥ï¼‰"
puts "2. æˆ–è€…åœ¨æœ¬åœ°æ¨é€åˆ° GitHub åï¼Œç”¨ GitHub Actions éƒ¨ç½²\n"

send "exit\r"
expect eof

puts "\nğŸ‰ Done!"
