#!/usr/bin/expect -f

# å…‹éš†ä»£ç å¹¶é…ç½®æœåŠ¡å™¨ç¯å¢ƒ
set timeout 60
set server_ip "120.53.220.231"
set server_user "ubuntu"
set server_password "Shunlian04"

puts "\n=========================================="
puts "ğŸ“¦ å…‹éš†ä»£ç å¹¶é…ç½®æœåŠ¡å™¨ç¯å¢ƒ"
puts "=========================================="

# SSH è¿æ¥
spawn ssh $server_user@$server_ip

expect "password:" {
    send "$server_password\r"
}

expect "ubuntu@*" {
    puts "\nâœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨\n"
}

# å…‹éš†ä»£ç 
puts "1ï¸âƒ£  å…‹éš†ä»£ç ä»“åº“..."
send "cd /opt/intent-test-framework\r"
expect "ubuntu@*"

# æ£€æŸ¥æ˜¯å¦éœ€è¦å…‹éš†
send "if \[ ! -f README.md \]; then echo 'EMPTY'; fi\r"
expect {
    "EMPTY" {
        puts "\nğŸ“¥ å¼€å§‹å…‹éš†ä»£ç ..."
        send "git clone https://github.com/pollyan/intent-test-framework.git .\r"
        expect {
            "Cloning into" {
                expect "ubuntu@*"
                puts "\nâœ… ä»£ç å…‹éš†æˆåŠŸ"
            }
            timeout {
                puts "\nâŒ å…‹éš†è¶…æ—¶"
            }
        }
    }
    "ubuntu@*" {
        puts "\nâœ… ä»£ç å·²å­˜åœ¨"
    }
}

# é…ç½® .env
puts "\n2ï¸âƒ£  é…ç½® .env æ–‡ä»¶..."
send "cat > .env << 'ENVEOF'\r"
expect ">"
send "# æ•°æ®åº“é…ç½® - ä½¿ç”¨ Supabase\r"
expect ">"
send "DATABASE_URL=postgresql://postgres.jzmqsuxphksbulrbhebp:Shunlian04@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?sslmode=require&connect_timeout=15&application_name=prod\r"
expect ">"
send "\r"
expect ">"
send "# Flask é…ç½®\r"
expect ">"
send "SECRET_KEY=\\\$(openssl rand -hex 32)\r"
expect ">"  
send "FLASK_ENV=production\r"
expect ">"
send "\r"
expect ">"
send "# æœåŠ¡ç«¯å£\r"
expect ">"
send "WEB_PORT=5001\r"
expect ">"
send "ENVEOF\r"
expect "ubuntu@*"

# ç”Ÿæˆå¹¶æ›¿æ¢ SECRET_KEY
send "RANDOM_KEY=\\\$(openssl rand -hex 32); sed -i \"s/\\\\\\\$(openssl rand -hex 32)/\\\$RANDOM_KEY/\" .env\r"
expect "ubuntu@*"

puts "\nâœ… .env æ–‡ä»¶å·²åˆ›å»º"

# æ˜¾ç¤ºé…ç½®
puts "\n3ï¸âƒ£  éªŒè¯ .env é…ç½®..."
send "cat .env\r"
expect "ubuntu@*"

# ä¿®æ”¹ docker-compose.prod.yml
puts "\n4ï¸âƒ£  ä¿®æ”¹ docker-compose.prod.yml..."
send "if grep -q '^  postgres:' docker-compose.prod.yml; then sed -i '/^  postgres:/,/^  web-app:/{ /^  postgres:/,/^  web-app:/{ /^  web-app:/!s/^/#/; } }' docker-compose.prod.yml; echo 'MODIFIED'; fi\r"
expect {
    "MODIFIED" {
        puts "\nâœ… docker-compose.prod.yml å·²ä¿®æ”¹ï¼ˆpostgres æœåŠ¡å·²æ³¨é‡Šï¼‰"
        expect "ubuntu@*"
    }
    "ubuntu@*" {
        puts "\nâš ï¸  docker-compose.prod.yml å¯èƒ½å·²ç»é…ç½®è¿‡"
    }
}

# æµ‹è¯• Docker
puts "\n5ï¸âƒ£  æµ‹è¯• Dockerï¼ˆæ„å»ºé•œåƒï¼‰..."
send "docker-compose -f docker-compose.prod.yml build web-app\r"
set timeout 300
expect {
    "Successfully built" {
        puts "\nâœ… Docker é•œåƒæ„å»ºæˆåŠŸ"
        expect "ubuntu@*"
    }
    "Successfully tagged" {
        puts "\nâœ… Docker é•œåƒæ„å»ºæˆåŠŸ"
        expect "ubuntu@*"
    }
    timeout {
        puts "\nâ³ æ„å»ºæ—¶é—´è¾ƒé•¿ï¼Œè¯·ç¨å€™..."
        expect "ubuntu@*"
    }
}

puts "\n=========================================="
puts "âœ… æœåŠ¡å™¨ç¯å¢ƒé…ç½®å®Œæˆï¼"
puts "=========================================="
puts "\nğŸ“‹ ä¸‹ä¸€æ­¥ï¼š"
puts "1. é…ç½® GitHub Secretsï¼ˆç§é’¥å·²åœ¨ä¸Šä¸€æ­¥æ˜¾ç¤ºï¼‰"
puts "2. æ¨é€ä»£ç è§¦å‘éƒ¨ç½²"
puts "3. è®¿é—® http://120.53.220.231:5001 éªŒè¯\n"

send "exit\r"
expect eof

puts "\nğŸ‰ é…ç½®å®Œæˆï¼"
