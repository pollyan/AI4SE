#!/usr/bin/expect -f

# æœåŠ¡å™¨è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬ï¼ˆä½¿ç”¨ ubuntu ç”¨æˆ·ï¼‰
# æœåŠ¡å™¨: 120.53.220.231
# ç”¨æˆ·: ubuntu
# å¯†ç : Shunlian04

set timeout 120
set server_ip "120.53.220.231"
set server_user "ubuntu"
set server_password "Shunlian04"

puts "\n=========================================="
puts "ğŸ”§ é…ç½®æœåŠ¡å™¨ç”¨äº CI/CD éƒ¨ç½²"
puts "æœåŠ¡å™¨: $server_ip"
puts "ç”¨æˆ·: $server_user"
puts "=========================================="

# SSH è¿æ¥åˆ°æœåŠ¡å™¨
spawn ssh $server_user@$server_ip

# å¤„ç†é¦–æ¬¡è¿æ¥çš„æŒ‡çº¹ç¡®è®¤
expect {
    "Are you sure you want to continue connecting" {
        send "yes\r"
        exp_continue
    }
    "password:" {
        send "$server_password\r"
    }
}

# ç­‰å¾…ç™»å½•æˆåŠŸ
expect "ubuntu@*" {
    puts "\nâœ… SSH è¿æ¥æˆåŠŸ\n"
}

# 1. ç”Ÿæˆ SSH å¯†é’¥
puts "\n1ï¸âƒ£  ç”Ÿæˆéƒ¨ç½²ä¸“ç”¨ SSH å¯†é’¥..."
send "ssh-keygen -t ed25519 -C 'github-actions-deploy' -f ~/.ssh/github_deploy -N ''\r"
expect "ubuntu@*"
send "ls -la ~/.ssh/github_deploy*\r"
expect "ubuntu@*"

# 2. é…ç½® authorized_keys
puts "\n2ï¸âƒ£  é…ç½® authorized_keys..."
send "cat ~/.ssh/github_deploy.pub >> ~/.ssh/authorized_keys\r"
expect "ubuntu@*"
send "chmod 600 ~/.ssh/authorized_keys\r"
expect "ubuntu@*"

# 3. æ£€æŸ¥ Docker
puts "\n3ï¸âƒ£  æ£€æŸ¥ Docker..."
send "docker --version\r"
expect {
    "Docker version" {
        puts "\nâœ… Docker å·²å®‰è£…"
        expect "ubuntu@*"
    }
    "command not found" {
        puts "\nğŸ“¥ å®‰è£… Docker..."
        send "curl -fsSL https://get.docker.com -o get-docker.sh\r"
        expect "ubuntu@*"
        send "sudo sh get-docker.sh\r"
        expect {
            "password" {
                send "$server_password\r"
                expect "ubuntu@*"
            }
            "ubuntu@*" {}
        }
        send "sudo systemctl start docker\r"
        expect "ubuntu@*"
        send "sudo systemctl enable docker\r"
        expect "ubuntu@*"
        send "sudo usermod -aG docker ubuntu\r"
        expect "ubuntu@*"
    }
}

# 4. åˆ›å»ºé¡¹ç›®ç›®å½•
puts "\n4ï¸âƒ£  å‡†å¤‡é¡¹ç›®ç›®å½•..."
send "sudo mkdir -p /opt/intent-test-framework\r"
expect {
    "password" {
        send "$server_password\r"
        expect "ubuntu@*"
    }
    "ubuntu@*" {}
}
send "sudo chown ubuntu:ubuntu /opt/intent-test-framework\r"
expect "ubuntu@*"

# 5. å…‹éš†ä»£ç ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
send "if \[ ! -d /opt/intent-test-framework/.git \]; then echo 'NEED_CLONE'; fi\r"
expect {
    "NEED_CLONE" {
        puts "\nâš ï¸  é¡¹ç›®ç›®å½•ä¸ºç©ºï¼Œéœ€è¦æ‰‹åŠ¨å…‹éš†ä»£ç "
        expect "ubuntu@*"
    }
    "ubuntu@*" {
        puts "\nâœ… é¡¹ç›®ä»£ç å·²å­˜åœ¨"
    }
}

# 6. é…ç½®é˜²ç«å¢™
puts "\n5ï¸âƒ£  é…ç½®é˜²ç«å¢™..."
send "sudo ufw allow 80/tcp\r"
expect {
    "password" {
        send "$server_password\r"
        expect "ubuntu@*"
    }
    "ubuntu@*" {}
}
send "sudo ufw allow 443/tcp\r"
expect "ubuntu@*"
send "sudo ufw allow 5001/tcp\r"
expect "ubuntu@*"

# 7. æ˜¾ç¤ºç§é’¥
puts "\n=========================================="
puts "âœ… æœåŠ¡å™¨é…ç½®å®Œæˆï¼"
puts "=========================================="
puts "\nğŸ“‹ GitHub Secrets é…ç½®ä¿¡æ¯ï¼š"
puts "----------------------------------------"
puts "SSH_PRIVATE_KEY çš„å€¼ï¼ˆå¤åˆ¶ä»¥ä¸‹å®Œæ•´å†…å®¹ï¼‰:\n"
send "cat ~/.ssh/github_deploy\r"
expect "ubuntu@*"
puts "\n----------------------------------------"
puts "\nSERVER_HOST: 120.53.220.231"
puts "SERVER_USER: ubuntu\n"

puts "\nğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
puts "1. å¤åˆ¶ä¸Šé¢çš„ç§é’¥åˆ° GitHub Secrets (SSH_PRIVATE_KEY)"
puts "2. æ·»åŠ  SERVER_HOST: 120.53.220.231"
puts "3. æ·»åŠ  SERVER_USER: ubuntu"
puts ""

send "exit\r"
expect eof

puts "\nğŸ‰ é…ç½®å®Œæˆï¼"
