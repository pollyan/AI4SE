# Clarify é˜¶æ®µé‡æ„è®¾è®¡

> **æ—¥æœŸ**: 2026-01-30  
> **çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å®ç°  
> **èŒƒå›´**: Lisa æµ‹è¯•è®¾è®¡å·¥ä½œæµ - éœ€æ±‚æ¾„æ¸… (clarify) é˜¶æ®µ

---

## 1. èƒŒæ™¯ä¸é—®é¢˜

### 1.1 å½“å‰æ¶æ„

Lisa æµ‹è¯•è®¾è®¡å·¥ä½œæµåŒ…å« 4 ä¸ªé˜¶æ®µï¼š

```
clarify (éœ€æ±‚æ¾„æ¸…) â†’ strategy (ç­–ç•¥åˆ¶å®š) â†’ cases (ç”¨ä¾‹ç¼–å†™) â†’ delivery (æ–‡æ¡£äº¤ä»˜)
```

å½“å‰å®ç°ä¸­ï¼Œé˜¶æ®µæµè½¬é€»è¾‘éšå¼åµŒå…¥åœ¨ Prompt å’Œ `reasoning_node` ä¸­ï¼Œç¼ºä¹æ˜¾å¼çš„çŠ¶æ€ç®¡ç†ã€‚

### 1.2 æ ¸å¿ƒç—›ç‚¹

| ç—›ç‚¹ | æè¿° |
|------|------|
| **é˜¶æ®µç›®æ ‡ä¸è¾¹ç•Œä¸æ¸…æ™°** | ä¸æ¸…æ¥š clarify é˜¶æ®µç»“æŸæ—¶åº”è¾¾æˆä»€ä¹ˆå…±è¯†ï¼Œä»€ä¹ˆé—®é¢˜å¿…é¡»åœ¨è¿™ä¸ªé˜¶æ®µè§£å†³ |
| **å¯¹è¯ç­–ç•¥ä¸æ˜ç¡®** | æ‰¹é‡æé—® vs é€æ¡å¼•å¯¼ï¼Ÿä¸»å¯¼å¼ vs å“åº”å¼ï¼Ÿç¼ºä¹ä¸€è‡´çš„äº¤äº’èŒƒå¼ |
| **ç¼ºä¹è¿›åº¦å¯è§æ€§** | ç”¨æˆ·å’Œç³»ç»Ÿéƒ½ä¸æ¸…æ¥šå½“å‰ç¦» "Done" è¿˜å·®ä»€ä¹ˆ (æš‚ç¼“å¤„ç†) |

---

## 2. é˜¶æ®µç›®æ ‡ä¸è¾¹ç•Œå®šä¹‰

### 2.1 æ ¸å¿ƒèŒè´£

**clarify é˜¶æ®µçš„æ ¸å¿ƒèŒè´£ï¼šå»ºç«‹æµ‹è¯•åŸºç¡€ä¿¡æ¯ (Testing Foundation)**

| å¿…é¡»å®Œæˆ (Hard Requirements) | å¯é€‰/åç»­å¤„ç† (Soft Requirements) |
|------------------------------|-----------------------------------|
| âœ… è¯†åˆ«è¢«æµ‹å¯¹è±¡ (SUT) | â³ è¯¦ç»†çš„ä¸šåŠ¡è§„åˆ™åˆ†æ |
| âœ… ç¡®å®šæµ‹è¯•èŒƒå›´è¾¹ç•Œ (Scope/Out-of-Scope) | â³ éåŠŸèƒ½éœ€æ±‚ç»†åŒ– |
| âœ… æ¢³ç†æ ¸å¿ƒä¸šåŠ¡æµç¨‹ (Main Flow) | â³ å®Œæ•´çš„å¼‚å¸¸åœºæ™¯æšä¸¾ |
| âœ… æ”¶é›†æ‰€æœ‰é˜»å¡æ€§ç–‘é—® (Blocking Questions) | â³ æµ‹è¯•ç¯å¢ƒ/æ•°æ®éœ€æ±‚ |

### 2.2 å‡†å‡ºæ ‡å‡† (Definition of Ready)

```
clarify é˜¶æ®µ DoR = ä»¥ä¸‹ 3 é¡¹å…¨éƒ¨æ»¡è¶³ï¼š

1. [è¢«æµ‹å¯¹è±¡æ˜ç¡®] SUT å·²è¯†åˆ«ï¼Œç”¨æˆ·ç¡®è®¤äº†æµ‹è¯•ç›®æ ‡å’Œè¾¹ç•Œ
2. [ä¸»æµç¨‹å¯è¾¾] è‡³å°‘ 1 æ¡æ ¸å¿ƒä¸šåŠ¡æµç¨‹å¯ç»˜åˆ¶ä¸ºæ—¶åºå›¾/æµç¨‹å›¾
3. [æ— é˜»å¡ç–‘é—®] æ‰€æœ‰é˜»å¡æ€§é—®é¢˜å·²è§£å†³ï¼Œæˆ–ç”¨æˆ·æ˜ç¡®é€‰æ‹©"å¸¦é£é™©ç»§ç»­"
```

### 2.3 ä¸åç»­é˜¶æ®µçš„è¾¹ç•Œ

| é˜¶æ®µ | è¾“å…¥ | è¾“å‡º | è¾¹ç•Œè¯´æ˜ |
|------|------|------|----------|
| **clarify** | åŸå§‹éœ€æ±‚ææ–™ | éœ€æ±‚åˆ†ææ–‡æ¡£ (å« SUTã€æµç¨‹ã€ç–‘é—®) | ä¸åšé£é™©åˆ†æã€ä¸åšæµ‹è¯•è®¾è®¡ |
| **strategy** | éœ€æ±‚åˆ†ææ–‡æ¡£ | æµ‹è¯•ç­–ç•¥è“å›¾ (å«é£é™©ã€ä¼˜å…ˆçº§) | åŸºäº clarify äº§å‡ºç‰©è¿›è¡Œé£é™©é©±åŠ¨åˆ†æ |

---

## 3. å­é˜¶æ®µåˆ’åˆ† (æ¦‚å¿µè®¾è®¡)

> **æ³¨æ„**: æ­¤éƒ¨åˆ†ä¸ºæ¦‚å¿µè®¾è®¡ï¼Œå…·ä½“å®ç°æ–¹æ¡ˆï¼ˆèŠ‚ç‚¹æ‹†åˆ† vs çŠ¶æ€å­—æ®µæ§åˆ¶ï¼‰åç»­ç¡®å®šã€‚

### 3.1 ä¸‰ä¸ªå­é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     clarify é˜¶æ®µ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¥ Intake        â†’    ğŸ” Analysis     â†’    ğŸ¤ Alignment        â”‚
â”‚  (ä¿¡æ¯æ”¶é›†)            (éœ€æ±‚åˆ†æ)            (å…±è¯†å¯¹é½)          â”‚
â”‚                                                                  â”‚
â”‚  ç›®æ ‡ï¼šæ”¶é›†ææ–™        ç›®æ ‡ï¼šè¯†åˆ«é—®é¢˜        ç›®æ ‡ï¼šè§£å†³é—®é¢˜        â”‚
â”‚  å‡†å‡ºï¼šæœ‰å¯åˆ†æè¾“å…¥    å‡†å‡ºï¼šäº§å‡ºç‰©å·²ç”Ÿæˆ    å‡†å‡ºï¼šDoRæ»¡è¶³+ç¡®è®¤    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å„å­é˜¶æ®µèŒè´£

| å­é˜¶æ®µ | ç›®æ ‡ | Lisa è¡Œä¸º | ç”¨æˆ·è¡Œä¸º | å‡†å‡ºæ¡ä»¶ |
|--------|------|-----------|----------|----------|
| **Intake** | æ”¶é›†åŸå§‹éœ€æ±‚ | å‘é€æ¬¢è¿è¯­ï¼Œå¼•å¯¼ç”¨æˆ·æä¾›ææ–™ | ç²˜è´´éœ€æ±‚æ–‡æ¡£/æè¿°éœ€æ±‚ | `has_user_input = true` |
| **Analysis** | ä¸“ä¸šåˆ†æ | è§£æéœ€æ±‚ï¼Œè¯†åˆ« SUT/ä¸»æµç¨‹/ç–‘é—®ç‚¹ï¼Œç”Ÿæˆäº§å‡ºç‰© | ç­‰å¾…/è¡¥å……ä¿¡æ¯ | `artifact_generated = true` |
| **Alignment** | å…±è¯†ç¡®è®¤ | å±•ç¤ºç–‘é—®åˆ—è¡¨ï¼Œé€é¡¹ç¡®è®¤æˆ–æ‰¹é‡ç¡®è®¤ | å›ç­”é—®é¢˜/ç¡®è®¤ç»§ç»­ | `dor_met = true && user_confirmed = true` |

---

## 4. å¯¹è¯ç­–ç•¥è®¾è®¡

### 4.1 å¯¹è¯èŠ‚å¥

| è½®æ¬¡ | Lisa è¡Œä¸º | æœŸæœ›ç”¨æˆ·è¡Œä¸º |
|------|-----------|--------------|
| **ç¬¬ 1 è½®** | å‘é€æ¬¢è¿è¯­ï¼Œåˆ—å‡ºéœ€è¦ç”¨æˆ·æä¾›çš„ 4 ç±»ä¿¡æ¯ | æä¾›éœ€æ±‚ææ–™ |
| **ç¬¬ 2 è½®** | åˆ†æææ–™ï¼Œç”Ÿæˆäº§å‡ºç‰©ï¼Œ**ä¸€æ¬¡æ€§åˆ—å‡ºæ‰€æœ‰ç–‘é—®**ï¼ˆåˆ†ç±»å‘ˆç°ï¼‰ | å›ç­”é—®é¢˜ / è¡¥å……ä¿¡æ¯ |
| **ç¬¬ 3+ è½®** | æ ¹æ®å›ç­”æ›´æ–°äº§å‡ºç‰©ï¼Œæ£€æŸ¥ DoRï¼Œå¦‚æœ‰æ–°ç–‘é—®ç»§ç»­è¿½é—® | æŒç»­æ¾„æ¸… |
| **æœ€å 1 è½®** | DoR æ»¡è¶³åï¼Œå‘ˆç°æ€»ç»“ + é—ç•™é£é™© + å¾æ±‚ç¡®è®¤ | ç¡®è®¤è¿›å…¥ä¸‹ä¸€é˜¶æ®µ |

### 4.2 é—®é¢˜åˆ†çº§æœºåˆ¶

é—®é¢˜æŒ‰é˜»å¡ç¨‹åº¦åˆ†ä¸ºä¸‰çº§ï¼Œåœ¨å¯¹è¯å’Œäº§å‡ºç‰©ä¸­åˆ†ç±»å‘ˆç°ï¼š

```markdown
## å¾…æ¾„æ¸…é—®é¢˜

### ğŸ”´ é˜»å¡æ€§é—®é¢˜ (å¿…é¡»è§£å†³)
> è¿™äº›é—®é¢˜ä¸è§£å†³å°†ç›´æ¥å½±å“æµ‹è¯•è®¾è®¡çš„æœ‰æ•ˆæ€§

1. [Q1] ç”¨æˆ·ç™»å½•å¤±è´¥åçš„é‡è¯•æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ
2. [Q2] è®¢å•é‡‘é¢çš„æœ‰æ•ˆèŒƒå›´æ˜¯å¤šå°‘ï¼Ÿ

### ğŸŸ¡ å»ºè®®æ¾„æ¸… (æ¨èè§£å†³)
> è¿™äº›é—®é¢˜ä¼šå½±å“æµ‹è¯•è¦†ç›–çš„å®Œæ•´æ€§ï¼Œä½†å¯ä»¥å¸¦é£é™©ç»§ç»­

3. [Q3] æ˜¯å¦éœ€è¦è€ƒè™‘å›½é™…åŒ–åœºæ™¯ï¼Ÿ
4. [Q4] å¹¶å‘ç”¨æˆ·æ•°çš„é¢„æœŸå³°å€¼ï¼Ÿ

### âšª å¯é€‰ç»†åŒ– (åç»­è¡¥å……)
> è¿™äº›é—®é¢˜å¯ä»¥åœ¨åç»­é˜¶æ®µé€æ­¥æ˜ç¡®

5. [Q5] æµ‹è¯•ç¯å¢ƒçš„å…·ä½“é…ç½®ï¼Ÿ
```

### 4.3 DoR æ£€æŸ¥ä¸æµè½¬è§„åˆ™

```python
def should_transition_to_strategy(state) -> Tuple[bool, Optional[str]]:
    """
    æ£€æŸ¥æ˜¯å¦æ»¡è¶³æµè½¬åˆ° strategy é˜¶æ®µçš„æ¡ä»¶
    
    Returns:
        (can_transition, reason_if_not)
    """
    # æ£€æŸ¥é˜»å¡æ€§é—®é¢˜æ˜¯å¦å…¨éƒ¨è§£å†³
    blocking_resolved = all(
        q.status == "resolved" 
        for q in state.questions 
        if q.level == "blocking"
    )
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç¡®è®¤
    user_confirmed = state.last_user_intent == "confirm_proceed"
    
    if not blocking_resolved:
        return False, "ä»æœ‰é˜»å¡æ€§é—®é¢˜æœªè§£å†³"
    
    if not user_confirmed:
        return False, "ç­‰å¾…ç”¨æˆ·ç¡®è®¤"
    
    return True, None
```

---

## 5. ç”¨æˆ·æ„å›¾è¯­ä¹‰è§£æ

### 5.1 è®¾è®¡åŸåˆ™

**æ ¸å¿ƒåŸåˆ™ï¼šä½¿ç”¨ LLM è¯­ä¹‰ç†è§£ï¼Œè€Œéå…³é”®å­—åŒ¹é…**

ç”¨æˆ·è¡¨è¾¾æ–¹å¼å¤šæ ·ï¼Œä¾‹å¦‚ï¼š
- "å¥½çš„" / "å¯ä»¥" / "æ²¡é—®é¢˜" / "ç»§ç»­å§" / "Let's go" â†’ éƒ½æ˜¯ç¡®è®¤ç»§ç»­
- "ç­‰ç­‰" / "è¿˜æœ‰ä¸ªé—®é¢˜" / "æˆ‘æƒ³å†ç¡®è®¤ä¸€ä¸‹" â†’ éƒ½æ˜¯éœ€è¦æ›´å¤šæ¾„æ¸…

å…³é”®å­—åŒ¹é…æ— æ³•è¦†ç›–è¿™ç§å¤šæ ·æ€§ï¼Œå¿…é¡»ä½¿ç”¨ LLM è¿›è¡Œè¯­ä¹‰ç†è§£ã€‚

### 5.2 æ„å›¾ç±»å‹å®šä¹‰

```python
class UserIntentInClarify(BaseModel):
    """clarify é˜¶æ®µç”¨æˆ·æ„å›¾è§£æç»“æœ"""
    
    intent: Literal[
        "provide_material",    # æä¾›éœ€æ±‚ææ–™/è¡¥å……ä¿¡æ¯
        "answer_question",     # å›ç­”ç‰¹å®šé—®é¢˜
        "confirm_proceed",     # ç¡®è®¤ç»§ç»­åˆ°ä¸‹ä¸€é˜¶æ®µ
        "need_more_clarify",   # éœ€è¦æ›´å¤šæ¾„æ¸…/æœ‰æ–°é—®é¢˜
        "accept_risk",         # æ¥å—é£é™©ï¼Œå¿½ç•¥æœªè§£å†³é—®é¢˜ç»§ç»­
        "change_scope",        # è°ƒæ•´æµ‹è¯•èŒƒå›´
        "off_topic"            # ç¦»é¢˜/æ— å…³è¯·æ±‚
    ] = Field(description="ç”¨æˆ·å½“å‰å›å¤çš„æ ¸å¿ƒæ„å›¾")
    
    confidence: float = Field(
        ge=0.0, le=1.0, 
        description="æ„å›¾è¯†åˆ«ç½®ä¿¡åº¦"
    )
    
    answered_question_ids: List[str] = Field(
        default_factory=list,
        description="å¦‚æœæ˜¯å›ç­”é—®é¢˜ï¼Œæ ‡è®°å›ç­”äº†å“ªäº›é—®é¢˜çš„ ID"
    )
    
    extracted_info: Optional[str] = Field(
        default=None,
        description="ä»ç”¨æˆ·å›å¤ä¸­æå–çš„å…³é”®ä¿¡æ¯æ‘˜è¦"
    )
```

### 5.3 è§£æå®ç°

```python
def parse_user_intent(user_message: str, context: ClarifyContext) -> UserIntentInClarify:
    """
    è¯­ä¹‰è§£æç”¨æˆ·æ„å›¾ (ä½¿ç”¨ LLM structured output)
    
    Args:
        user_message: ç”¨æˆ·æœ€æ–°æ¶ˆæ¯
        context: å½“å‰ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«å¾…è§£å†³é—®é¢˜åˆ—è¡¨ã€å½“å‰é˜¶æ®µç­‰ï¼‰
    """
    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªæ„å›¾åˆ†æä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·åœ¨éœ€æ±‚æ¾„æ¸…é˜¶æ®µçš„å›å¤æ„å›¾ã€‚
    
    ## å½“å‰ä¸Šä¸‹æ–‡
    - é˜¶æ®µ: éœ€æ±‚æ¾„æ¸… (clarify)
    - å¾…è§£å†³çš„é˜»å¡æ€§é—®é¢˜: {context.blocking_questions}
    - å¾…è§£å†³çš„å»ºè®®æ¾„æ¸…é—®é¢˜: {context.optional_questions}
    
    ## ç”¨æˆ·å›å¤
    "{user_message}"
    
    ## ä»»åŠ¡
    1. åˆ¤æ–­ç”¨æˆ·æ„å›¾ç±»å‹
    2. å¦‚æœç”¨æˆ·åœ¨å›ç­”é—®é¢˜ï¼Œè¯†åˆ«å›ç­”äº†å“ªäº›é—®é¢˜
    3. æå–ç”¨æˆ·å›å¤ä¸­çš„å…³é”®ä¿¡æ¯
    
    æ³¨æ„ï¼š
    - ä½¿ç”¨è¯­ä¹‰ç†è§£ï¼Œä¸è¦ä¾èµ–å…³é”®å­—åŒ¹é…
    - è€ƒè™‘ä¸Šä¸‹æ–‡ï¼ŒåŒæ ·çš„è¯åœ¨ä¸åŒè¯­å¢ƒä¸‹å¯èƒ½æœ‰ä¸åŒå«ä¹‰
    """
    
    return llm.with_structured_output(UserIntentInClarify).invoke(prompt)
```

### 5.4 æ„å›¾é©±åŠ¨çš„è¡Œä¸ºåˆ†å‘

```python
def handle_user_intent(intent: UserIntentInClarify, state: LisaState):
    """æ ¹æ®ç”¨æˆ·æ„å›¾æ‰§è¡Œç›¸åº”åŠ¨ä½œ"""
    
    match intent.intent:
        case "confirm_proceed":
            can_proceed, reason = should_transition_to_strategy(state)
            if can_proceed:
                return transition_to_strategy()
            else:
                return prompt_blockers(reason)
        
        case "accept_risk":
            # ç”¨æˆ·é€‰æ‹©å¿½ç•¥é£é™©ï¼Œéœ€è¦äºŒæ¬¡ç¡®è®¤
            return request_explicit_risk_confirmation()
        
        case "answer_question":
            # æ›´æ–°é—®é¢˜çŠ¶æ€
            update_question_status(intent.answered_question_ids)
            refresh_artifact()
            return check_dor_and_respond()
        
        case "need_more_clarify":
            return continue_clarification()
        
        case "provide_material":
            # æœ‰æ–°ææ–™ï¼Œé‡æ–°è¿›å…¥ Analysis
            return analyze_new_material(intent.extracted_info)
        
        case "change_scope":
            return handle_scope_change()
        
        case "off_topic":
            return redirect_to_clarify_topic()
```

---

## 6. å®ç°è·¯çº¿å›¾

### Phase 1: Prompt é‡æ„ (å½“å‰è®¾è®¡è¦†ç›–)
- [ ] æ›´æ–° `STAGE_CLARIFY_PROMPT`ï¼Œæ˜ç¡®é˜¶æ®µç›®æ ‡å’Œè¾¹ç•Œ
- [ ] æ·»åŠ é—®é¢˜åˆ†çº§æœºåˆ¶çš„ Prompt æŒ‡å¼•
- [ ] æ·»åŠ  DoR æ£€æŸ¥é€»è¾‘çš„ Prompt æè¿°

### Phase 2: æ„å›¾è§£æå®ç°
- [ ] æ–°å¢ `UserIntentInClarify` Schema
- [ ] åœ¨ `reasoning_node` å‰æ·»åŠ æ„å›¾è§£ææ­¥éª¤
- [ ] å®ç°æ„å›¾é©±åŠ¨çš„è¡Œä¸ºåˆ†å‘

### Phase 3: è¿›åº¦å¯è§æ€§ (åç»­)
- [ ] ç¡®å®šå­é˜¶æ®µå®ç°æ–¹æ¡ˆ (èŠ‚ç‚¹æ‹†åˆ† vs çŠ¶æ€å­—æ®µ)
- [ ] å‰ç«¯è¿›åº¦æ¡æ”¯æŒ clarify å­é˜¶æ®µæ˜¾ç¤º
- [ ] State æ‰©å±•æ”¯æŒ DoR checklist

---

## 7. é™„å½•

### 7.1 ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `tools/ai-agents/backend/agents/lisa/state.py` | Lisa çŠ¶æ€å®šä¹‰ |
| `tools/ai-agents/backend/agents/lisa/nodes/reasoning_node.py` | æ¨ç†èŠ‚ç‚¹ |
| `tools/ai-agents/backend/agents/lisa/prompts/workflows/test_design.py` | æµ‹è¯•è®¾è®¡ Prompt |
| `tools/ai-agents/backend/agents/lisa/schemas.py` | Schema å®šä¹‰ |

### 7.2 å‚è€ƒèµ„æ–™

- å½“å‰ clarify é˜¶æ®µ Prompt: `STAGE_CLARIFY_PROMPT`
- å½“å‰ DoR å®šä¹‰ (Prompt å†…åµŒ): å®ä½“ä¸è¾¹ç•Œæ˜ç¡® + ä¸»æµç¨‹å¯è¾¾
