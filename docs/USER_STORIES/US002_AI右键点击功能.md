# 用户故事 US002: AI 右键点击功能

**创建日期**: 2025-01-28  
**优先级**: 高  
**状态**: 需求分析完成  
**预估工作量**: 2-3天  
**MidScene 版本要求**: 0.23.4+

## 📋 需求概述

**背景**: MidScene 0.23.4 版本新增了 `agent.aiRightClick()` 方法，支持对 Web 元素执行右键点击操作。当前我们的测试框架缺少此功能，导致无法测试依赖右键交互的业务场景。

**目标**: 在 Intent Test Framework 中集成 AI 右键点击功能，使测试工程师能够测试上下文菜单、右键拖拽等高级交互场景，完善 UI 自动化测试的覆盖范围。

## 🎯 业务价值

- **测试覆盖完整性**: 填补右键交互测试空白，提升测试场景覆盖率至95%+
- **业务场景支持**: 支持富交互 Web 应用的完整测试，如在线编辑器、图表工具等
- **用户体验保障**: 确保右键菜单功能的稳定性，避免用户交互异常
- **测试效率提升**: 自动化原本需要手工测试的右键交互场景，减少30%的手工测试工作量

## 👥 用户画像

**主要用户**: 高级测试工程师、自动化测试专家  
**技术水平**: 熟悉前端技术和复杂交互测试  
**工作场景**: 负责富交互应用的端到端测试  
**痛点**: 现有工具无法自动化测试右键交互，导致测试覆盖不全

## 📊 业务场景分析

### 核心业务场景

1. **内容管理系统测试**: 右键编辑、删除、复制内容等操作
2. **在线编辑器测试**: 右键格式化、插入元素、属性设置等功能
3. **数据表格测试**: 右键排序、筛选、导出等数据操作
4. **图形界面测试**: 右键创建节点、连接、属性编辑等绘图操作
5. **文件管理测试**: 右键上传、下载、重命名等文件操作

### 技术限制理解
- 仅支持 Web 应用自定义的上下文菜单
- 无法测试浏览器原生右键菜单（如"查看源代码"等）
- 需要配合 `aiTap` 等方法完成菜单项选择

## 🚀 用户故事

### 故事1: 基础右键点击操作
**作为** 测试工程师  
**我希望** 能够对页面元素执行右键点击操作  
**以便** 触发元素的上下文菜单进行后续测试  

**验收条件**:
```gherkin
Given 我正在编辑一个测试步骤
When 我选择"aiRightClick"动作类型
And 我在参数中指定目标元素定位描述
Then 系统应该在步骤编辑界面显示正确的参数模板
And 参数模板应该包含"locate"字段用于元素定位
And 参数模板应该包含可选的"options"配置项
And 执行该步骤时应该能成功触发目标元素的右键点击事件
```

### 故事2: 上下文菜单交互测试
**作为** 测试工程师  
**我希望** 能够在右键点击后与弹出的上下文菜单进行交互  
**以便** 完成完整的右键操作流程测试  

**验收条件**:
```gherkin
Given 我有一个右键点击步骤和一个后续的菜单点击步骤
When 第一个步骤执行右键点击操作
Then 应该触发目标元素的上下文菜单显示
When 第二个步骤执行aiTap点击菜单项
Then 应该能够成功选择菜单项并执行相应操作
And 整个交互流程应该在3秒内完成
And 系统应该正确记录每个步骤的执行状态
```

### 故事3: 复杂表格右键功能测试
**作为** 测试工程师  
**我希望** 能够测试数据表格中的右键菜单功能  
**以便** 验证表格的编辑、删除、导出等业务功能  

**验收条件**:
```gherkin
Given 页面上有一个包含上下文菜单的数据表格
When 我创建一个右键点击表格行的测试步骤
And 参数中使用自然语言描述目标行（如"第一行数据"）
Then 执行时应该能准确定位到指定的表格行
And 应该能触发该行的右键上下文菜单
And 菜单中应该显示"编辑"、"删除"等选项
When 我添加后续步骤点击"删除"选项
Then 应该能成功执行删除操作
And 表格数据应该更新反映删除结果
```

### 故事4: 图形编辑器右键测试
**作为** 测试工程师  
**我希望** 能够测试图形编辑器中的右键创建功能  
**以便** 验证复杂绘图应用的交互逻辑  

**验收条件**:
```gherkin
Given 页面上有一个支持右键创建的图形编辑器
When 我创建右键点击画布空白区域的测试步骤
And 参数中指定画布的具体位置描述
Then 执行时应该在指定位置触发右键点击
And 应该显示包含"创建节点"等选项的上下文菜单
When 我添加步骤点击"创建节点"选项
Then 应该在画布上创建新的图形节点
And 节点应该出现在右键点击的位置
And 创建操作应该被正确记录到画布历史中
```

### 故事5: 错误处理和边界情况
**作为** 测试工程师  
**我希望** 在右键点击无效元素时获得清晰的错误提示  
**以便** 快速定位和修复测试脚本问题  

**验收条件**:
```gherkin
Given 我创建了一个右键点击不存在元素的测试步骤
When 执行该测试步骤
Then 应该返回明确的错误信息说明元素未找到
And 错误信息应该包含查找的元素描述
And 错误信息应该提供可能的解决建议
Given 我右键点击一个不支持上下文菜单的元素
When 执行该测试步骤
Then 步骤应该成功执行但记录警告信息
And 警告信息应该说明该元素未响应右键点击事件
And 后续步骤应该能够继续正常执行
```

### 故事6: 性能和选项配置
**作为** 测试工程师  
**我希望** 能够配置右键点击的执行选项  
**以便** 优化测试执行性能和准确性  

**验收条件**:
```gherkin
Given 我在右键点击步骤的options参数中设置了deepThink选项
When 执行该步骤时
Then AI应该使用更精确的元素定位策略
And 定位时间可能会增加但准确性更高
Given 我设置了cacheable选项为true
When 在同一测试用例中多次执行相似的右键点击
Then 应该能够利用缓存提升执行效率
And 缓存命中时的执行时间应该减少50%以上
And 缓存应该在测试用例结束后自动清理
```

## 🛠️ 功能集成要求

### 步骤编辑器集成
1. **动作类型选择器扩展**
   - 在"智能交互类"分组中添加"aiRightClick"选项
   - 提供清晰的功能描述："AI右键点击 - 触发元素上下文菜单"

2. **参数模板定义**
```json
{
  "locate": "目标元素的自然语言描述",
  "options": {
    "deepThink": false,
    "cacheable": false
  }
}
```

3. **参数验证规则**
   - locate字段必填，且长度大于3个字符
   - options为可选对象，包含布尔型字段
   - 提供参数格式的实时验证和提示

### 执行引擎集成
1. **midscene_server.js扩展**
   - 添加新的API端点 `/ai-right-click`
   - 实现参数解析和MidScene API调用
   - 添加错误处理和重试机制

2. **midscene_python.py扩展**
   - 在MidSceneAI类中添加`ai_right_click`方法
   - 提供Python风格的API接口
   - 集成日志记录和状态反馈

## ⚠️ 功能边界和限制

### 技术限制
1. **仅支持Web自定义菜单**: 无法操作浏览器原生右键菜单
2. **依赖页面实现**: 需要页面元素正确实现右键事件处理
3. **与其他步骤协作**: 通常需要配合aiTap等步骤完成完整流程

### 使用约束
1. **元素可见性要求**: 目标元素必须在页面中可见和可交互
2. **时序依赖**: 右键点击后的菜单操作需要合理的时间间隔
3. **浏览器兼容性**: 不同浏览器的右键事件实现可能存在差异

## 🔧 技术实现要点

### 前端实现要求
1. **动作类型注册**
```javascript
const actionTypes = {
  // 现有动作类型...
  'aiRightClick': {
    name: 'AI右键点击',
    group: '智能交互类',
    description: '对指定元素执行右键点击操作',
    defaultParams: {
      locate: '目标元素描述',
      options: {
        deepThink: false,
        cacheable: false
      }
    },
    validation: {
      locate: { required: true, minLength: 3 }
    }
  }
};
```

2. **参数处理逻辑**
   - 智能参数保留：从其他动作类型切换时保留locate字段
   - 默认值生成：自动生成合理的options配置
   - 验证反馈：实时验证参数格式并提供错误提示

### 后端API扩展
1. **新增HTTP端点**
```javascript
app.post('/ai-right-click', async (req, res) => {
  const { locate, options = {} } = req.body;
  // 参数验证和处理
  // 调用MidScene API
  // 错误处理和响应
});
```

2. **Python封装方法**
```python
def ai_right_click(self, locate: str, deep_think: bool = False, cacheable: bool = False):
    """执行AI右键点击操作"""
    # 实现细节
```

## 📈 实施优先级

### P0 (核心功能 - 必须实现)
- 基础右键点击API集成
- 步骤编辑器的动作类型添加
- 基本参数验证和错误处理

### P1 (用户体验优化 - 强烈建议)
- 智能参数保留逻辑
- 详细的错误提示和引导
- 与现有动作类型的无缝切换

### P2 (高级功能 - 可选)
- 性能优化配置(deepThink, cacheable)
- 批量右键操作支持
- 高级调试和监控功能

## 📊 成功指标

### 功能指标
- 右键点击成功率 >95%
- 平均响应时间 <2秒
- 与其他动作类型兼容性 100%

### 业务指标
- 右键交互测试场景覆盖率 >90%
- 手工测试工作量减少 >30%
- 用户采用率 >80%（3个月内）

## 🔍 风险评估

### 技术风险 (低)
- MidScene API稳定，集成风险较小
- 现有框架扩展性良好，改动影响可控
- 浏览器兼容性问题可通过测试避免

### 用户体验风险 (中)
- 用户需要理解技术限制（仅支持自定义菜单）
- 参数配置复杂度略有增加
- 与现有工作流程的学习成本

### 业务风险 (低)
- 不影响现有功能，向后兼容
- 属于功能增强，无业务中断风险
- 可通过灰度发布控制影响范围

## 📝 测试策略

### 单元测试
- 参数验证逻辑测试
- API调用和响应处理测试
- 错误情况的异常处理测试

### 集成测试
- 与MidScene后端服务的集成测试
- 前端界面的交互流程测试
- 不同浏览器的兼容性测试

### 用户验收测试
- 真实业务场景的端到端测试
- 复杂交互流程的稳定性测试
- 性能和用户体验的评估测试

---

**需求状态**: 业务分析完成，待技术设计和实施  
**下一步**: 确认需求细节，开始技术实现方案设计  
**负责人**: 开发团队  
**评审人**: 产品经理、测试团队负责人