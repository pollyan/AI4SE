# 用户故事 US004: 执行过程数据获取功能 (_unstableLogContent)

**创建日期**: 2025-01-28  
**优先级**: 高  
**状态**: 需求分析完成  
**预估工作量**: 4-5天  
**MidScene 版本要求**: 0.23.4+

## 📋 需求概述

**背景**: MidScene 0.23.4 版本新增了 `agent._unstableLogContent()` API，可以获取测试执行过程中的详细数据，包括每个步骤的执行时间、AI token 消耗量和截图信息。这为性能优化、成本控制和深度调试提供了强大的数据支持。

**目标**: 在 Intent Test Framework 中集成执行过程数据获取功能，为不同角色的用户提供测试性能监控、AI 成本分析、详细调试信息和自定义报告生成能力，提升测试流程的可观测性和可优化性。

## 🎯 业务价值

- **成本透明化**: 提供详细的 AI token 消耗统计，支持精确的成本预算和控制
- **性能优化支持**: 通过执行时间分析识别性能瓶颈，优化测试执行效率 40%+  
- **深度调试能力**: 提供丰富的执行过程数据，减少问题排查时间 60%+
- **自定义报告**: 支持生成定制化的测试分析报告，满足不同层级的汇报需求
- **预测性分析**: 基于历史数据预测测试成本和执行时间，支持资源规划

## 👥 用户画像分析

### 测试团队负责人
**关注点**: 成本控制、团队效率、资源规划  
**需求**: 成本趋势分析、性能基准对比、团队使用情况统计  

### 测试工程师  
**关注点**: 测试调试、性能优化、问题排查  
**需求**: 步骤级执行详情、失败原因分析、性能热点识别  

### 运维团队
**关注点**: 系统稳定性、资源使用、监控告警  
**需求**: 系统负载监控、异常检测、容量规划  

### 项目经理
**关注点**: 项目成本、交付效率、质量指标  
**需求**: 成本报告、效率报告、质量趋势分析  

## 📊 业务场景分析

### 核心业务场景

1. **AI 成本管理**: 实时监控和历史分析 AI token 消耗，为预算规划提供数据支持
2. **性能优化**: 识别执行时间长的步骤和操作，指导测试脚本优化
3. **问题诊断**: 通过详细的执行日志快速定位测试失败的根本原因  
4. **容量规划**: 基于历史数据预测未来的资源需求和成本
5. **质量报告**: 生成面向管理层的测试质量和效率报告

### 数据价值分析
- **实时性**: 支持执行过程中的实时监控和干预
- **完整性**: 覆盖测试执行的全生命周期数据
- **可追溯性**: 提供测试结果的完整追溯链路
- **可分析性**: 结构化数据支持多维度分析和挖掘

## 🚀 用户故事

### 故事1: 执行过程数据收集
**作为** 测试工程师  
**我希望** 能够获取测试执行过程中的详细数据  
**以便** 分析测试性能和 AI 资源消耗情况  

**验收条件**:
```gherkin
Given 我执行了一个包含多个AI操作的测试用例
When 测试执行完成后
And 我调用执行过程数据获取接口
Then 应该返回包含以下信息的详细数据：
  - 每个步骤的开始和结束时间
  - 每个步骤的AI token消耗量
  - 每个步骤的截图信息和时间戳
  - 总体执行统计信息
And 数据格式应该是结构化的JSON格式
And 数据获取操作应该在1秒内完成
And 返回的数据大小应该在合理范围内（<10MB）
```

### 故事2: 实时性能监控
**作为** 测试团队负责人  
**我希望** 能够实时监控正在执行的测试的性能数据  
**以便** 及时发现异常并进行干预  

**验收条件**:
```gherkin
Given 有多个测试用例正在同时执行
When 我打开性能监控面板
Then 应该能够看到每个执行中测试的实时状态：
  - 当前执行的步骤和进度
  - 已消耗的AI token数量
  - 当前步骤的执行时间
  - 预计剩余执行时间
And 监控面板应该每5秒自动刷新数据
And 当单个测试执行时间超过预设阈值时应该高亮显示
And 应该支持按项目、测试类型等维度筛选
And 监控面板的加载时间应该少于2秒
```

### 故事3: AI 成本分析和预算控制
**作为** 项目经理  
**我希望** 能够分析 AI 使用成本并设置预算控制  
**以便** 合理规划项目成本和资源使用  

**验收条件**:
```gherkin
Given 系统已收集了一段时间的AI使用数据
When 我查看AI成本分析报告
Then 应该显示以下成本分析信息：
  - 按日/周/月的成本趋势图
  - 按测试用例类型的成本分布
  - 按团队成员的使用统计
  - 与预算的对比分析
And 应该支持设置成本预警阈值
When 实际成本接近预算阈值时
Then 应该发送预警通知给相关负责人
And 预警通知应该包含具体的超支风险和建议措施
And 成本数据应该支持导出为Excel格式
And 支持按不同AI服务商分别统计成本
```

### 故事4: 性能瓶颈分析和优化建议
**作为** 测试工程师  
**我希望** 能够识别测试执行中的性能瓶颈  
**以便** 有针对性地优化测试脚本和配置  

**验收条件**:
```gherkin
Given 我有一个执行时间较长的测试用例
When 我查看该测试用例的性能分析报告
Then 应该显示详细的性能分析信息：
  - 每个步骤的执行时间排序（从高到低）
  - 识别出的性能热点步骤（占总时间>10%）
  - AI调用延迟分析和异常检测
  - 截图操作的频率和耗时统计
And 系统应该提供优化建议：
  - 推荐启用缓存的步骤
  - 建议合并的相似操作
  - 推荐调整超时设置的步骤
And 应该提供性能对比功能：
  - 与历史执行的性能对比
  - 与同类测试用例的性能对比
And 分析结果应该支持保存和分享
```

### 故事5: 自定义报告生成
**作为** 测试团队负责人  
**我希望** 能够基于执行数据生成自定义报告  
**以便** 向上级汇报测试工作的进展和成效  

**验收条件**:
```gherkin
Given 系统中积累了丰富的测试执行数据
When 我创建一个自定义报告
Then 应该支持以下报告配置选项：
  - 时间范围选择（最近7天、30天、自定义范围）
  - 数据维度选择（成本、性能、质量、覆盖率）
  - 展示方式选择（图表、表格、趋势分析）
  - 对比基准选择（同期对比、目标对比）
And 生成的报告应该包含：
  - 执行摘要和关键指标
  - 详细的数据分析和趋势图
  - 问题识别和改进建议
  - 成本效益分析
And 报告生成时间应该在30秒内完成
And 支持多种导出格式（PDF、PPT、Excel）
And 报告模板应该支持自定义和保存
```

### 故事6: 调试信息增强和问题排查
**作为** 测试工程师  
**我希望** 在测试失败时能够获得详细的调试信息  
**以便** 快速定位和解决问题  

**验收条件**:
```gherkin
Given 一个测试用例执行失败
When 我查看该测试的详细执行日志
Then 应该显示增强的调试信息：
  - 失败步骤的详细执行上下文
  - 失败时刻的页面截图和DOM状态
  - AI模型的输入和输出详情
  - 网络请求和响应信息
  - 浏览器控制台错误信息
And 应该提供调试工具：
  - 步骤级别的重试功能
  - 参数调整和测试功能
  - 类似问题的历史搜索
And 调试信息应该支持导出和分享
And 系统应该自动识别常见错误模式并提供解决建议
And 支持将调试会话保存为可复现的测试案例
```

## 🛠️ 技术实现要求

### API 集成设计
1. **midscene_server.js 扩展**
```javascript
// 新增数据获取端点
app.get('/api/execution-data/:executionId', async (req, res) => {
  const { executionId } = req.params;
  try {
    // 获取原始执行数据
    const logContent = agent._unstableLogContent();
    
    // 数据处理和增强
    const enhancedData = processExecutionData(logContent, executionId);
    
    res.json({
      success: true,
      data: enhancedData
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// 实时监控端点
app.get('/api/realtime-monitoring', (req, res) => {
  // WebSocket or Server-Sent Events implementation
});
```

2. **数据处理和存储**
```javascript
function processExecutionData(rawLogContent, executionId) {
  return {
    executionId,
    timestamp: new Date().toISOString(),
    summary: {
      totalSteps: rawLogContent.steps.length,
      totalTime: calculateTotalTime(rawLogContent),
      totalTokens: calculateTotalTokens(rawLogContent),
      successRate: calculateSuccessRate(rawLogContent)
    },
    steps: rawLogContent.steps.map(processStepData),
    screenshots: rawLogContent.screenshots,
    performance: analyzePerformance(rawLogContent),
    cost: calculateCost(rawLogContent)
  };
}
```

### 前端界面设计
1. **监控面板组件**
```html
<div class="monitoring-dashboard">
  <div class="real-time-stats">
    <div class="stat-card">
      <h3>活动测试</h3>
      <span class="stat-value">{{ activeTests }}</span>
    </div>
    <div class="stat-card">
      <h3>今日Token消耗</h3>
      <span class="stat-value">{{ todayTokens }}</span>
    </div>
    <div class="stat-card">
      <h3>平均响应时间</h3>
      <span class="stat-value">{{ avgResponseTime }}ms</span>
    </div>
  </div>
  <div class="execution-list">
    <!-- 执行列表 -->
  </div>
  <div class="performance-charts">
    <!-- 性能图表 -->
  </div>
</div>
```

2. **数据分析界面**
```html
<div class="analytics-panel">
  <div class="filter-controls">
    <select id="timeRange">
      <option value="7d">最近7天</option>
      <option value="30d">最近30天</option>
      <option value="custom">自定义</option>
    </select>
    <select id="dimension">
      <option value="cost">成本分析</option>
      <option value="performance">性能分析</option>
      <option value="quality">质量分析</option>
    </select>
  </div>
  <div class="charts-container">
    <!-- 动态图表展示 -->
  </div>
  <div class="insights-panel">
    <!-- AI驱动的洞察建议 -->
  </div>
</div>
```

### 数据库设计
```sql
-- 执行过程数据表
CREATE TABLE execution_data (
  id VARCHAR(255) PRIMARY KEY,
  testcase_id INT,
  execution_id VARCHAR(255),
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  total_steps INT,
  success_steps INT,
  failed_steps INT,
  total_tokens INT,
  total_cost DECIMAL(10,4),
  raw_log_data JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 步骤执行详情表
CREATE TABLE step_execution_details (
  id INT AUTO_INCREMENT PRIMARY KEY,
  execution_data_id VARCHAR(255),
  step_index INT,
  step_type VARCHAR(100),
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  duration_ms INT,
  tokens_consumed INT,
  success BOOLEAN,
  error_message TEXT,
  screenshot_path VARCHAR(500),
  FOREIGN KEY (execution_data_id) REFERENCES execution_data(id)
);

-- 性能统计表
CREATE TABLE performance_stats (
  id INT AUTO_INCREMENT PRIMARY KEY,
  date DATE,
  hour INT,
  total_executions INT,
  avg_execution_time DECIMAL(10,2),
  total_tokens_consumed BIGINT,
  total_cost DECIMAL(10,4),
  success_rate DECIMAL(5,2),
  INDEX idx_date_hour (date, hour)
);
```

## ⚠️ 风险评估和应对策略

### API 稳定性风险 (高)
**风险描述**: `_unstableLogContent` API 带有 _unstable 前缀，表示未来版本可能发生变化

**应对策略**:
1. **抽象层设计**: 创建数据获取抽象层，隔离直接的 API 调用
2. **版本兼容性**: 维护多个 MidScene 版本的适配代码
3. **降级策略**: 当 API 不可用时提供基础功能
4. **监控告警**: 监控 API 调用异常，及时发现版本兼容问题

```javascript
// 抽象层示例
class ExecutionDataCollector {
  async getLogContent(agent) {
    try {
      // 尝试使用新版API
      if (typeof agent._unstableLogContent === 'function') {
        return await agent._unstableLogContent();
      }
      // 降级到基础数据收集
      return this.collectBasicData(agent);
    } catch (error) {
      console.warn('Failed to get detailed log content, using fallback');
      return this.collectBasicData(agent);
    }
  }
  
  collectBasicData(agent) {
    // 基础数据收集逻辑
    return {
      timestamp: new Date().toISOString(),
      message: 'Detailed logging not available'
    };
  }
}
```

### 性能影响风险 (中)
**风险描述**: 详细数据收集可能影响测试执行性能

**应对策略**:
1. **异步处理**: 数据收集和处理使用异步模式，不阻塞测试执行
2. **可配置采集**: 提供数据采集级别配置，平衡详细度与性能
3. **批量处理**: 批量处理和存储数据，减少频繁的数据库操作
4. **缓存机制**: 对频繁查询的数据进行缓存

### 数据隐私风险 (中)
**风险描述**: 执行数据可能包含敏感的业务信息

**应对策略**:
1. **数据脱敏**: 对敏感数据进行自动脱敏处理
2. **访问控制**: 实施细粒度的数据访问权限控制
3. **数据保留**: 制定数据保留策略，定期清理历史数据
4. **加密存储**: 对敏感数据进行加密存储

## 📈 实施优先级

### P0 (核心功能 - 必须实现)
- 基础的执行数据收集功能
- 简单的监控界面
- 基础的成本统计功能

### P1 (重要功能 - 强烈建议)
- 实时监控面板
- 性能分析和优化建议
- 预警和告警机制

### P2 (增强功能 - 可选)
- 高级自定义报告
- 预测性分析
- 第三方系统集成

## 📊 成功指标

### 功能指标
- 数据收集成功率 >99%
- 监控界面响应时间 <2秒
- 数据查询性能 <5秒（90%的查询）

### 业务指标
- 问题排查效率提升 >60%
- 成本透明度提升 100%（之前无相关数据）
- 用户采用率 >75%（3个月内）

### 技术指标
- 系统性能影响 <5%
- 数据准确性 >99%
- API 兼容性维护率 >95%

---

**需求状态**: 业务分析完成，需重点关注API稳定性风险  
**下一步**: 开始技术可行性评估和风险缓解方案设计  
**负责人**: 开发团队 + 架构师  
**评审人**: 技术总监、产品经理、测试团队负责人