# 故事 1.2: 实时AI回应和澄清引导

## 基本信息
- **故事ID**: STORY-01-02
- **所属Epic**: Epic 1: 智能需求分析核心体验
- **优先级**: 高
- **故事点数**: 13
- **复杂度**: 高
- **状态**: 待开发

## INVEST原则检查
- **Independent**: ✅ 依赖Story 1.1的对话基础设施，但核心AI逻辑独立
- **Negotiable**: ✅ AI澄清策略和提示词可协商优化
- **Valuable**: ✅ 提供核心价值 - AI智能澄清和需求理解能力
- **Estimable**: ✅ 涉及复杂AI逻辑设计，工作量可估算
- **Small**: ✅ 专注于澄清引导功能，规模可控
- **Testable**: ✅ 可通过对话场景和AI回应质量验证

## 用户故事

### 主要故事
**作为** 需求描述者（项目经理、产品经理）
**我希望** AI助手Mary能够智能理解我的需求描述，识别信息缺口，并通过专业问题引导我澄清细节
**以便** 我能够在AI的专业指导下，将模糊的想法逐步完善成清晰、结构化的需求

### 使用场景
用户在对话界面输入初步需求描述后，AI Mary会分析需求内容，识别出缺失的关键信息（如用户角色、功能范围、技术约束等），然后通过结构化的问题引导用户逐步澄清这些细节。整个过程中，右侧共识区域会实时显示AI理解和确认的需求要点。

### 触发条件
- 用户发送第一条需求描述消息
- 用户回答AI的澄清问题
- AI检测到需求信息仍有缺失或模糊之处

### 相关故事
- Story 1.1: AI需求分析对话界面（前置依赖）
- Story 1.3: 需求分析进度可视化
- Story 1.4: AI配置管理

## 详细描述

### 功能概述
实现基于BMAD架构的AI需求澄清引擎，AI Mary完全自主地分析用户输入，识别需求缺口，选择合适的澄清方法，生成专业的引导问题。同时在右侧共识区域实时展示AI理解的需求要点，让用户清晰了解AI接受了哪些信息。

### 主要操作流程
1. 用户输入需求描述
2. AI需求分析引擎解析输入内容
3. AI识别需求类型（功能需求、系统需求、业务需求等）
4. AI检测信息缺口（用户角色、功能范围、技术约束、优先级等）
5. AI从澄清方法库中选择合适的澄清策略
6. AI生成结构化澄清问题
7. AI提取确认的需求要点，更新右侧共识内容
8. AI返回回应消息和共识更新

### 用户界面要求
**右侧共识区域**：
- **已达成共识**板块：显示AI确认理解的需求要点
- **共识条目格式**：分类标签 + 内容摘要 + 详细说明
- **实时更新**：每轮对话后自动更新共识内容
- **分类显示**：按功能类型、用户角色、技术约束等分类展示

**AI消息增强**：
- 支持结构化问题格式（1. 2. 3.）
- 专业术语解释和建议
- 引用相关最佳实践

### 数据处理要求
**AI上下文管理**：
```json
{
  "session_context": {
    "identified_requirements": [
      {
        "category": "功能类型",
        "content": "用户登录系统", 
        "confidence": 0.9,
        "details": "需要开发用户身份验证和会话管理功能"
      }
    ],
    "information_gaps": [
      "用户角色定义",
      "登录方式选择", 
      "安全要求规格"
    ],
    "clarification_history": [
      {
        "method": "用户角色澄清",
        "questions_asked": ["这个登录系统主要服务哪些用户群体？"],
        "answers_received": [],
        "status": "pending"
      }
    ]
  }
}
```

**澄清方法库**：
```python
CLARIFICATION_METHODS = {
    "用户角色澄清": {
        "trigger_keywords": ["用户", "登录", "系统", "平台"],
        "questions": [
            "这个系统主要服务哪些用户群体？",
            "不同用户角色有什么不同的需求？",
            "预期的用户规模大概是多少？"
        ]
    },
    "功能范围界定": {
        "trigger_keywords": ["功能", "特性", "模块"],
        "questions": [
            "核心功能有哪些，优先级如何？",
            "哪些功能是必须的，哪些是可选的？",
            "是否需要与现有系统集成？"
        ]
    },
    "技术约束识别": {
        "trigger_keywords": ["技术", "性能", "安全", "兼容"],
        "questions": [
            "有什么特殊的技术要求或限制？",
            "性能方面有什么具体指标？",
            "安全级别要求如何？"
        ]
    }
}
```

### 业务规则
**AI决策原则（BMAD架构）**：
- AI完全自主选择澄清方法，不依赖程序逻辑分支
- AI根据上下文动态调整问题策略
- AI自主判断澄清完成度，决定何时进入下一阶段
- AI自主管理共识内容的提取和分类

**澄清质量控制**：
- 单轮对话最多提出3-4个澄清问题
- 避免重复询问已澄清的信息点
- 优先澄清对后续分析影响最大的信息缺口
- AI自主识别用户的回答质量，必要时追问细节

## 验收标准

### 主要验收场景

**场景1**: AI理解简单需求并进行澄清
```gherkin
Given 用户输入"我想开发一个用户登录系统"
When AI处理这条消息
Then AI识别出这是用户认证类功能需求
And AI在右侧共识区显示"功能类型：用户登录系统"
And AI返回澄清问题询问用户群体、登录方式、安全要求
And AI的问题结构清晰，专业性强
```

**场景2**: AI处理复杂业务需求
```gherkin
Given 用户输入"我们需要一个电商平台，支持多商家入驻"
When AI分析这个复杂需求
Then AI识别出业务领域为电商，模式为B2B2C
And 右侧显示"业务领域：电商平台"和"平台类型：多商家入驻模式"
And AI询问商家管理、商品分类、支付结算等关键问题
```

**场景3**: AI识别信息缺口并引导澄清
```gherkin
Given 用户描述了基本功能但缺少用户角色信息
When AI检测到用户角色信息缺失
Then AI主动询问目标用户群体
And 将"用户角色"标记为待澄清信息
And 引导用户提供用户画像和使用场景
```

**场景4**: 共识内容实时更新
```gherkin
Given 用户回答了AI关于用户角色的问题
When AI处理用户回答"主要是企业内部员工使用"
Then 右侧共识区新增"用户角色：企业内部员工"
And 更新需求理解的置信度
And AI基于新信息调整后续澄清策略
```

### 边界场景

**边界场景1**: 处理模糊或不完整的用户回答
```gherkin
Given AI询问"需要支持哪些登录方式"
When 用户回答"常用的方式就行"
Then AI识别出回答不够具体
And AI进一步澄清"是否包括邮箱、手机号、第三方登录等"
And 不将模糊信息加入共识内容
```

**边界场景2**: 处理超出能力范围的需求
```gherkin
Given 用户描述极为复杂的企业级系统需求
When AI分析发现涉及多个专业领域
Then AI承认复杂性并建议分阶段澄清
And 优先澄清最核心的功能模块
And 在共识区标记"复杂度：高"
```

### 异常处理场景

**异常场景1**: AI服务响应异常
```gherkin
Given 用户发送了需求描述
When AI分析服务出现错误
Then 系统显示友好的错误提示
And 提供重试选项
And 保持已有的共识内容不丢失
```

**异常场景2**: 用户输入无关内容
```gherkin
Given 用户输入"今天天气怎么样"
When AI分析发现与需求无关
Then AI礼貌地引导用户回到需求讨论
And 不在共识区记录无关信息
And 建议用户描述具体的功能需求
```

## 非功能性要求

### 性能要求
- AI分析和回应生成时间 < 5秒
- 共识内容更新延迟 < 1秒
- 支持上下文长度 > 8K tokens
- 澄清方法匹配准确率 > 85%

### 安全要求
- AI输出内容安全过滤
- 防止prompt injection攻击
- 用户输入内容敏感信息检测
- AI回应内容审核机制

### 可用性要求
- AI回应语言自然、专业
- 问题结构化程度高，易于理解
- 共识内容分类清晰，便于检索
- 支持中英文混合输入

### 兼容性要求
- 支持多种AI模型（GPT-4、Claude、Qwen等）
- 兼容不同的prompt格式
- 支持模型切换时的上下文保持

## 设计注意事项

### UI/UX设计要点
- **共识区域设计**：分类卡片展示，支持展开/收起
- **AI消息格式**：结构化问题使用编号列表
- **置信度指示**：用颜色深浅表示AI理解的确信程度
- **澄清进度**：显示当前澄清的主要方向和完成度

### 技术实现要点
- **BMAD架构实现**：AI决策引擎完全基于prompt驱动
- **上下文管理**：使用结构化JSON存储对话上下文
- **澄清策略**：基于关键词触发和语义匹配的混合方法
- **模型集成**：支持多种AI模型的统一接口

### 数据设计要点
- **澄清方法库**：可配置的YAML或JSON格式
- **共识提取**：基于实体识别和关系抽取
- **上下文压缩**：长对话的智能摘要和关键信息保持

### 集成要求
- **AI服务API**：扩展midscene_server.js支持需求分析
- **多模型支持**：统一的AI调用接口
- **提示词管理**：版本化的prompt模板系统

## 测试指导

### 测试重点
1. **AI理解准确性** - 需求识别、信息缺口检测
2. **澄清策略有效性** - 问题质量、澄清逻辑
3. **共识提取正确性** - 信息归纳、分类准确性
4. **上下文管理** - 多轮对话的连贯性

### 关键测试场景
1. 不同类型需求的理解测试（功能、非功能、业务需求）
2. 复杂需求的逐步澄清测试
3. 模糊输入的处理测试
4. 多轮对话的上下文保持测试
5. 不同AI模型的一致性测试

### 测试数据要求
- 准备不同复杂度的需求描述样本
- 构建标准的澄清问题质量评估标准
- 创建共识提取的准确性基准
- 设计多轮对话的测试用例

### 自动化测试建议
- AI回应质量的自动评估
- 澄清逻辑的单元测试
- 上下文管理的集成测试
- 多模型兼容性的回归测试

### 测试工具建议
- AI质量评估：自定义评估框架
- API测试：pytest + requests
- 性能测试：locust
- 上下文测试：自定义测试工具

## 依赖关系

### 前置故事
- Story 1.1: AI需求分析对话界面（必须完成）

### 技术依赖
- AI服务提供商API（OpenAI、DashScope等）
- midscene_server.js的扩展开发
- 自然语言处理库（如spaCy或jieba）
- 提示词模板管理系统

### 数据依赖
- 澄清方法库的设计和配置
- 需求类型分类体系
- 共识提取的规则配置

### 外部依赖
- AI服务的稳定性和配额
- 网络连接质量
- AI模型的更新和变化

### 阻塞风险
- AI服务API变更或限流
- 澄清质量不达预期需要大量调优
- 多模型兼容性问题

## 完成定义

### 开发完成标准
- [ ] AI需求分析引擎核心逻辑实现
- [ ] 澄清方法库设计和配置完成
- [ ] 共识提取和分类功能实现
- [ ] 多AI模型兼容接口完成
- [ ] 上下文管理和持久化完成
- [ ] 代码通过同行评审
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过

### 测试完成标准
- [ ] AI理解准确性测试通过（准确率 > 85%）
- [ ] 澄清引导有效性验证通过
- [ ] 共识提取正确性测试通过
- [ ] 多轮对话上下文测试通过
- [ ] 异常处理测试通过
- [ ] 性能测试满足要求

### 文档完成标准
- [ ] AI引擎API文档完成
- [ ] 澄清方法库配置文档
- [ ] 提示词模板文档
- [ ] 故障排除指南

### 产品负责人验收
- [ ] AI理解和澄清质量满足期望
- [ ] 共识内容准确性满足要求
- [ ] 多轮对话体验流畅自然
- [ ] 产品负责人最终验收通过

### 发布就绪标准
- [ ] 功能在测试环境稳定运行72小时
- [ ] AI服务监控和告警配置完成
- [ ] 澄清质量监控指标建立
- [ ] 紧急修复和回滚方案就绪

## 备注

这是智能需求分析的核心AI能力故事，实现难度较高，需要在AI理解准确性和澄清引导有效性之间找到平衡。建议采用迭代优化的方式，先实现基础功能，再逐步提升AI的智能化水平。

## 变更历史

| 日期 | 版本 | 变更内容 | 变更原因 | 变更人 |
|------|------|----------|----------|--------|
| 2024-01-20 | 1.0 | 初始创建故事文档 | 基于BMAD架构和AI澄清需求 | Scrum Master Bob |