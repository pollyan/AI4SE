# 故事 1.3: 需求分析进度可视化

## 基本信息
- **故事ID**: STORY-01-03
- **所属Epic**: Epic 1: 智能需求分析核心体验
- **优先级**: 中
- **故事点数**: 5
- **复杂度**: 中等
- **状态**: 待开发

## INVEST原则检查
- **Independent**: ✅ 基于已有对话和共识数据，可独立实现
- **Negotiable**: ✅ 进度展示方式和视觉设计可协商
- **Valuable**: ✅ 提供用户价值 - 清晰的分析进展反馈
- **Estimable**: ✅ 主要是前端展示逻辑，工作量可估算
- **Small**: ✅ 专注于进度可视化，规模适中
- **Testable**: ✅ 可通过界面状态和数据准确性验证

## 用户故事

### 主要故事
**作为** 需求描述者（项目经理、产品经理）
**我希望** 能够清晰地了解当前需求分析的进展状态和完成情况
**以便** 我知道还需要澄清哪些信息，整个分析过程进行到什么阶段

### 使用场景
用户在进行需求分析对话时，可以随时了解当前的分析进度。系统会在对话界面的右上角显示当前分析阶段，在右侧快速操作区域显示建议的澄清方向，帮助用户了解分析进展和下一步行动。

### 触发条件
- 创建新的需求分析会话时
- AI每次更新共识内容后
- 用户查看分析进度时
- 分析阶段发生变化时

### 相关故事
- Story 1.1: AI需求分析对话界面（前置依赖）
- Story 1.2: 实时AI回应和澄清引导（前置依赖）
- Story 1.4: AI配置管理

## 详细描述

### 功能概述
在对话界面中集成轻量级的进度可视化组件，通过简洁的状态指示和进度信息，让用户实时了解需求分析的当前阶段、完成程度和建议的下一步行动。

### 主要操作流程
1. 系统根据对话内容和共识数据分析当前阶段
2. 计算需求澄清的完成度（基于信息缺口数量）
3. 识别当前最需要澄清的信息类别
4. 在界面中更新阶段指示器和进度信息
5. 提供建议的澄清方向和快速问题

### 用户界面要求
**阶段指示器**（右上角）：
- 当前阶段文字显示（需求澄清/结构分析/文档准备）
- 彩色圆点状态指示（绿色-进行中，黄色-等待输入，红色-异常）
- 简洁不占用主要空间

**快速操作区域**（右侧中部）：
- 显示5个常用澄清问题按钮
- 基于当前分析状态动态调整问题内容
- 一键发送功能，提升澄清效率

**分析成果区域**（右侧下部）：
- 显示潜在可生成的文档状态
- PRD、用户故事、测试用例的就绪程度
- 灰色表示未就绪，绿色表示可生成

### 数据处理要求
**进度计算逻辑**：
```python
def calculate_analysis_progress(consensus_data, info_gaps):
    """计算需求分析进度"""
    total_required_info = len(REQUIRED_INFO_CATEGORIES)
    confirmed_info = len([c for c in consensus_data if c['confidence'] > 0.8])
    progress_percentage = (confirmed_info / total_required_info) * 100
    
    # 确定当前阶段
    if progress_percentage < 30:
        stage = "initial"  # 初始澄清
    elif progress_percentage < 70:
        stage = "clarifying"  # 深度澄清
    elif progress_percentage < 90:
        stage = "analyzing"  # 结构分析
    else:
        stage = "ready"  # 准备就绪
    
    return {
        "stage": stage,
        "progress": progress_percentage,
        "next_priorities": identify_next_priorities(info_gaps)
    }

REQUIRED_INFO_CATEGORIES = [
    "功能类型", "用户角色", "核心功能", "技术约束",
    "性能要求", "安全要求", "集成需求", "优先级"
]
```

**快速问题生成**：
```python
def generate_quick_questions(current_stage, info_gaps):
    """基于当前状态生成快速澄清问题"""
    if current_stage == "initial":
        return [
            "用户角色是什么？",
            "核心功能有哪些？", 
            "技术约束和限制？",
            "优先级排序？",
            "集成需求？"
        ]
    elif current_stage == "clarifying":
        # 基于具体缺失信息动态生成
        questions = []
        if "性能要求" in info_gaps:
            questions.append("性能指标要求？")
        if "安全要求" in info_gaps:
            questions.append("安全级别要求？")
        # ... 其他逻辑
        return questions
```

### 业务规则
**阶段判断规则**：
- 初始阶段：基础信息收集，进度 < 30%
- 澄清阶段：详细信息澄清，进度 30-70%
- 分析阶段：信息整理分析，进度 70-90%
- 就绪阶段：可生成文档，进度 > 90%

**进度更新规则**：
- 每次AI回应后重新计算进度
- 置信度 > 0.8的共识才计入完成进度
- 关键信息缺失时进度不能超过特定阈值

## 验收标准

### 主要验收场景

**场景1**: 新会话进度初始化
```gherkin
Given 用户创建新的需求分析会话
When 页面加载完成
Then 右上角显示"需求澄清"阶段
And 状态指示器显示绿色（正在进行）
And 快速操作区显示5个基础澄清问题
And 分析成果区显示所有文档为未就绪状态
```

**场景2**: 进度随对话更新
```gherkin
Given 用户已描述基本需求并获得AI回应
When AI更新了3个共识条目
Then 阶段可能从"初始"更新为"澄清"
And 快速问题根据当前缺失信息调整
And 界面实时反映新的进度状态
```

**场景3**: 澄清问题快速发送
```gherkin
Given 用户在快速操作区看到"用户角色是什么？"
When 用户点击该问题按钮
Then 问题自动填入输入框并发送
And AI处理该问题并返回回应
And 进度根据AI回应结果更新
```

**场景4**: 分析成果状态更新
```ghertml
Given 需求澄清达到80%完成度
When 系统评估文档生成就绪度
Then PRD文档状态变为绿色（可生成）
And 用户故事状态变为黄色（部分就绪）
And 测试用例保持灰色（未就绪）
```

### 边界场景

**边界场景1**: 进度倒退处理
```gherkin
Given 某个共识条目的置信度从0.9降到0.6
When 系统重新计算进度
Then 进度百分比相应下降
And 可能触发阶段回退
And 界面状态相应更新
```

**边界场景2**: 长期停滞状态
```gherkin
Given 用户长时间没有提供有效澄清信息
When 系统检测到分析停滞（10分钟无进展）
Then 状态指示器变为黄色（等待输入）
And 提供更具引导性的快速问题
```

### 异常处理场景

**异常场景1**: 进度计算异常
```gherkin
Given 共识数据出现异常或损坏
When 系统尝试计算分析进度
Then 显示默认的保守进度估算
And 记录错误日志
And 不影响对话功能的正常使用
```

**异常场景2**: 快速问题生成失败
```gherkin
Given 快速问题生成逻辑出现异常
When 系统无法生成个性化问题
Then 回退到默认的通用澄清问题
And 保持快速操作功能可用
```

## 非功能性要求

### 性能要求
- 进度计算响应时间 < 100ms
- 界面状态更新延迟 < 500ms
- 快速问题生成时间 < 200ms
- 不影响对话的主要性能

### 安全要求
- 进度数据不包含敏感信息
- 快速问题内容安全过滤
- 防止通过进度信息泄露会话内容

### 可用性要求
- 进度指示清晰易懂
- 快速问题表述准确专业
- 支持键盘快捷键操作
- 适配不同屏幕尺寸

### 兼容性要求
- 支持主流浏览器
- 移动端响应式适配
- 与现有UI组件风格一致

## 设计注意事项

### UI/UX设计要点
- **极简指示器**：右上角小巧的阶段指示，不干扰对话
- **彩色圆点系统**：绿色（进行中）、黄色（等待）、红色（异常）
- **快速操作布局**：紧凑的按钮组，易于点击
- **视觉层次**：进度信息作为辅助，不抢夺对话主体地位

### 技术实现要点
- **实时更新**：WebSocket推送进度变化
- **状态计算**：基于共识数据的算法逻辑
- **缓存优化**：进度计算结果缓存，避免重复计算
- **组件化设计**：进度相关组件可复用

### 数据设计要点
- **进度状态存储**：在RequirementsSession中增加progress_data字段
- **阶段定义**：可配置的阶段定义和转换规则
- **问题库管理**：结构化存储快速澄清问题

### 集成要求
- **与AI引擎集成**：获取共识置信度和信息缺口数据
- **WebSocket事件**：progress_updated事件类型
- **数据同步**：确保进度数据与对话数据一致性

## 测试指导

### 测试重点
1. **进度计算准确性** - 各种共识数据组合的进度计算
2. **状态转换正确性** - 阶段转换的触发条件和结果
3. **实时更新功能** - WebSocket推送和界面更新
4. **快速问题有效性** - 问题生成逻辑和发送功能

### 关键测试场景
1. 不同进度阶段的界面状态测试
2. 进度倒退和异常情况处理测试
3. 快速操作按钮的交互测试
4. 多用户会话的进度隔离测试
5. 性能压力下的进度更新测试

### 测试数据要求
- 不同完成度的共识数据样本
- 各种信息缺口组合的测试用例
- 阶段转换的边界条件数据
- 异常共识数据的处理测试

### 自动化测试建议
- 进度计算逻辑的单元测试
- WebSocket进度推送的集成测试
- 界面状态更新的前端测试
- 快速问题生成的功能测试

### 测试工具建议
- 单元测试：pytest
- 前端测试：Jest + Testing Library
- 集成测试：Playwright
- 性能测试：自定义性能监控

## 依赖关系

### 前置故事
- Story 1.1: AI需求分析对话界面（必须完成）
- Story 1.2: 实时AI回应和澄清引导（必须完成）

### 技术依赖
- WebSocket实时通信基础设施
- 共识数据结构和置信度算法
- 前端状态管理系统

### 数据依赖
- RequirementsSession模型的进度字段扩展
- 共识条目的置信度数据
- 澄清问题库的配置数据

### 外部依赖
无重大外部依赖

### 阻塞风险
- 共识数据结构变更可能影响进度计算
- WebSocket连接不稳定影响实时更新
- 快速问题质量需要持续优化

## 完成定义

### 开发完成标准
- [ ] 进度计算逻辑实现和测试完成
- [ ] 阶段指示器UI组件完成
- [ ] 快速操作区域实现完成
- [ ] WebSocket进度推送功能完成
- [ ] 分析成果状态展示完成
- [ ] 代码通过同行评审
- [ ] 单元测试覆盖率 > 85%
- [ ] 集成测试通过

### 测试完成标准
- [ ] 进度计算准确性验证通过
- [ ] 各阶段状态转换测试通过
- [ ] 实时更新功能测试通过
- [ ] 快速操作交互测试通过
- [ ] 异常处理测试通过
- [ ] 性能测试满足要求

### 文档完成标准
- [ ] 进度计算逻辑文档
- [ ] UI组件使用说明
- [ ] 快速问题配置文档

### 产品负责人验收
- [ ] 进度展示直观清晰
- [ ] 快速操作提升效率明显
- [ ] 用户体验符合预期
- [ ] 产品负责人最终验收通过

### 发布就绪标准
- [ ] 功能在测试环境稳定运行48小时
- [ ] 性能监控指标正常
- [ ] 与现有功能集成无冲突

## 备注

这个故事专注于用户体验的改善，通过清晰的进度指示帮助用户更好地理解和参与需求分析过程。实现相对简单，但需要仔细设计进度计算逻辑，确保准确性和实用性。

## 变更历史

| 日期 | 版本 | 变更内容 | 变更原因 | 变更人 |
|------|------|----------|----------|--------|
| 2024-01-20 | 1.0 | 初始创建故事文档 | 基于用户体验改善需求 | Scrum Master Bob |